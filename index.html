<!DOCTYPE html>
  <html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <title>JUKESTUDIO - Jukebox Title Strip Creator</title>
    <script src='pdfmake.min.js'></script>
    <script src='vfs_fonts.js'></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crel/3.1.0/crel.min.js"></script>
    <script src="https://use.fontawesome.com/434809f2b1.js"></script>
    <link rel="stylesheet" href="bootstrap.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <style>
      @import url('https://fonts.googleapis.com/css?family=Work+Sans:300,700');
      .navbar-dark .navbar-nav .nav-link:hover, .navbar-dark .navbar-nav .nav-link:focus { color: #FFD166; }
      .navbar.bg-default { background: #eeeeee; padding: .5rem 1rem; margin-top: 70px; }
      .navbar.bg-default a { color: #777777; }
      .navbar.bg-default a:hover { color: #3498DB; }
      .navbar.bg-gray { background-color: #26547C !important; }
      .navbar .navbar-brand { font-weight:200; font-family: 'Work Sans', sans-serif; color: #FFD166; }
      .navbar .navbar-brand strong { font-weight: 700; }
      .main-content { margin-top: 150px; }
      #welcome-message { font-family: 'Work Sans', sans-serif; }
      #welcome-message h2 { font-weight: 700; }
      .right { text-align: right; }
      .btn { border-radius: .17rem; border-width: 2px; }
      .btn:focus, .btn.focus { box-shadow: none; }
      .btn.btn-default { color: #888; border-color: #dddddd; }
      .btn.btn-success { color: #ffffff; background-color: #06D6A0; border-color: #06D6A0; }
      .btn.btn-primary { color: #ffffff; background-color: #6487A7; border-color: #6487A7; }
      .btn.btn-info { background: #FFD166; border-color: #FFD166; color: #575e68; }
      .btn.btn-danger { background: #C05E31; border-color: #C05E31; color: #ffffff; }
      .btn-info:not(:disabled):not(.disabled):active, .btn-info:not(:disabled):not(.disabled).active, .show > .btn-info.dropdown-toggle { background: #E4AA06; border-color: #E4AA06 }
      .btn-nofill { background-color: transparent; }
      .title input { border-radius: 0; border: 1px solid #fff; padding-left: 0; }
      .title input:focus, .title input:active { border-color: #fff; border-bottom: 1px solid #ced4da; box-shadow: none; background-color: #f5f5f5; }
      .modal-content { border: none; border-radius: .2rem; }
      .modal-header { padding: 2rem .75rem 1rem .75rem; background-color: transparent; border: none; border-top-left-radius: .2rem; border-top-right-radius: .2rem; font-size: 1.2rem; color: #555555; text-align: center; display: block; }
      .modal-header img { height: 40px; display: block; margin-left: auto; margin-right: auto; margin-bottom: .75rem; }
      .modal-footer { justify-content: center; border-top: none; padding-bottom: 2rem; }
      .modal-footer .btn { padding: .5rem 1.5rem; width: 35%; }
      .modal .close { color: #555555; opacity: 1; }
      .custom-checkbox .custom-control-input:checked ~ .custom-control-label::before { background-color: #FFD166; }
      #hidden-file { display: none; }
      .table .custom-control-label, .table .custom-control { display: inline; }
      #title-menu { position: absolute; display:none; }
      .title-menu-button { padding-left: .5rem; padding-right: .5rem; }
      a.title-menu-button { color: #555555; }
      .navbar { padding: .75rem; }
      .navbar.toolbar { margin-top: 60px; padding: .5rem; background-color: #26547C !important; }
      .navbar .btn { margin-right: 4px; border: none; }
      .navbar .btn.btn-default { background-color: #26547C; }
      .modal-body svg { display: block; margin-left: auto; margin-right: auto; }
    </style>
  </head>
  <body>
    <div class="navbar navbar-expand-lg fixed-top bg-gray navbar-dark">
      <div class="container">
        <a href="../" class="navbar-brand"><strong>JUKE</strong>STUDIO</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="nav navbar-nav ml-auto">
            <li class="nav-item">
            </li>
            <li class="nav-item">
              <a class="nav-link" id="menu-export" href="#">Import/Export</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <nav class="navbar navbar-light bg-light fixed-top toolbar">
      <div class="container">
      <form class="form-inline">
        <div class="input-group">
	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#add-modal"><img src="images/record.svg" style="height:21px"/></button>
	<button type="button" class="btn btn-default" id="menu-options"><img src="images/design.svg" style="height:21px"/></button>
	<button type="button" class="btn btn-default" id="write-document"><img src="images/print-white.svg" style="height:21px"/></button>
        </div>
      </form>
    </nav>

    <div class="container main-content">
      <div class="bs-docs-section clearfix">
        <div class="row">
          <div class="col-lg-12">
            <table class="table table-hover" id="titles">
              <thead>
                <tr>
                  <th>A Side</th>
                  <th>B Side</th>
                  <th>Artist</th>
                  <th colspan=2><!--Print--></tr>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="context-menu">
        <a class="dropdown-item edit" href="#">Edit</a>
        <a class="dropdown-item remove" href="#">Remove</a>
      </div>

    <div class="modal fade" id="options-modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <img src="images/design-dark.svg"/>
            Design
          </div>
          <div class="modal-body">
            <fieldset>
              <div class="form-group">
                <label for="option-paperType">Paper type</label>
                <select class="form-control" id="option-paperType">
                  <option value="letter">Plain paper (US Letter)</option>
                  <option value="double10">Pre-printed 5x2 (HxW)</option>
                  <option value="single12">Pre-printed 12x1 (HxW)</option>
                </select>
                <p id="paperType-message"></p>
              </div>
              <div class="form-group">
                <label for="option-font">Font</label>
                <select class="form-control" id="option-font">
                </select>
              </div>
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="option-uppercase">
                  <label class="custom-control-label" for="option-uppercase">Force uppercase</label>
                </div>
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="option-quotes">
                  <label class="custom-control-label" for="option-quotes">Add quotes to titles</label>
                </div>
              </div>
              <div class="form-group">
                <label for="option-style">Style</label>
                <select class="form-control onlyplain" id="option-style">
                </select>
              </div>
              <div class="form-group">
                <label for="option-primaryColor">Color</label><br>
                <select class="form-control onlyplain nocolor" id="option-primaryColor">
                  <option value="#ff0000">Red</option>
                  <option value="#00a0de">Blue</option>
                  <option value="#5fae6f">Green</option>
                  <option value="#80578f">Purple</option>
                  <option value="#EE6B3F">Orange</option>
                </select>
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input onlyplain nocolor" id="option-artistFillColor" checked="">
                  <label class="custom-control-label" for="option-artistFillColor">Colored background for artist</label>
                </div>
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input onlyplain nocolor" id="option-titleFillColor" checked="">
                  <label class="custom-control-label" for="option-titleFillColor">Colored background for titles</label>
                </div>
              </div>
            </fieldset>
	    <p style="align:center:">
	      <img src="images/designs/arrows.svg" style="width: 25%;" id="design-preview" class="svg" />
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-nofill" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success save-options">Save</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="add-modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <img src="images/record-dark.svg"/>
            Add record 
          </div>
          <div class="modal-body">
            <fieldset>
              <div class="form-group">
                <input type="text" class="form-control" id="add-side-a" placeholder="Side A"/>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control" id="add-side-b" placeholder="Side B"/>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control" id="add-artist" placeholder="Artist"/>
                <div class="invalid-feedback"></div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control" id="add-artist-b" placeholder="Side B artist (if different)"/>
              </div>
            </fieldset>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-nofill" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success save">Save</button>
          </div>
        </div>
      </div>
    </div>
    </div>

    <div class="modal fade" id="export-modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            Library
          </div>
          <div class="modal-body">
            <fieldset>
              <div class="form-group">
                <div class="custom-control custom-radio">
                  <input type="radio" id="export-all" name="customRadio" class="custom-control-input" checked="">
                  <label class="custom-control-label" for="export-all">Export library and settings</label>
                </div>
                <div class="custom-control custom-radio">
                  <input type="radio" id="export-titles" name="customRadio" class="custom-control-input">
                  <label class="custom-control-label" for="export-titles">Export library only (CSV)</label>
                </div>
              </div>
              <button type="button" class="btn btn-primary" id="export">Export</button>
            </fieldset>
            <hr/>
            <fieldset>
              <input id="hidden-file" type="file" accept=".json,.csv" />
              <p><small><strong>Note</strong>: To import a library in CSV format, your file must be arranged with exactly three columns as follows: Side A, Side B, Artist</small></p>
              <button type="button" class="btn btn-primary" id="import" onclick="document.getElementById('hidden-file').click();">Import</button>
            </fieldset>
            <hr/>
            <fieldset>
              <button type="button" class="btn btn-danger" id="options-clear">Clear library</button>
            </fieldset>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default btn-nofill" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </body>
  <script src="titlecreator.js"></script>
  <script>
    $(document).ready(function(){
    
      function addRow(content=null){
        if(content==null) return;

        var html=crel('tr',{'class':'title','data-id':content.id},
          crel('td',{'class':'aside'},content.aside),
          crel('td',{'class':'bside'},content.bside),
          crel('td',{'class':'artist'},content.artist + ((content.artistb!='' && content.artistb!=null) ? ' / '+content.artistb : '')),
          //crel('td',
          //  crel('div', {'class':'custom-control custom-checkbox'},
          //    crel('input', {'type':'checkbox', 'class':'custom-control-input', 'id':'print-title-'+content.id}),
          //    crel('label', {'class':'custom-control-label','for':'print-title-'+content.id},'')
          //  )
          //),
          crel('td',
            crel('a',{'href':'#','class':'title-menu-button'},
              crel('i',{'class':'fa fa-ellipsis-v','aria-hidden':'true'})
            )
          )
        );
        $('#titles tbody').append(html);
      }

      function exportLibrary(csv=false) {
        var out={
          titles:titleCreator.getTitles(),
          options:titleCreator.getOptions()
        }

        var data="",
            filename="";

        if(csv==false) {
          data="data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(out));
          filename="jukestudio.json";
        } else {
          data = "data:text/csv;charset=utf-8,";
          out.titles.forEach(function(a){
            data+=a.aside+','+a.bside+','+a.artist+'\r\n';
          });
          filename="jukestudio.csv"
        }
        var a=document.createElement('a');
        a.setAttribute("href", data);
        a.setAttribute("download",filename);
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      $('#hidden-file').on('change',function(evt){
        var file = evt.target.files[0];
        if(file.type!="application/vnd.ms-excel" && file.type!="application/json") return false;

        readFile = function (file) {
          var reader = new FileReader();
          reader.onload = function () {

            var d={};
            if(file.type=="application/vnd.ms-excel") {
              var ar=reader.result.split('\r\n');
              ar.reverse;
              ar.forEach(function(e){
                var b=e.split(',');
                if(b.length==3) {
                  d.append({aside:b[0],bside:b[1],artist:b[2]});
                }
              });
            } else {
              var ob=JSON.parse(reader.result);
              if(ob.hasOwnProperty('options') && ob.hasOwnProperty('titles')) {
                titleCreator.options=ob.options; //should fix this
                ob.titles.forEach(function(e){
                  if(e.hasOwnProperty('aside') && e.hasOwnProperty('bside') && e.hasOwnProperty('artist'))
                    var h=0;
                });
                d=ob.titles;
              }
            }
            $('#export-modal').modal('hide');
            d=titleCreator.addTitles(d);
            d.forEach(function(title){
              addRow({aside:title.aside,bside:title.bside,artist:title.artist,artistb:'',id:title.id});
            });
            if(titles.length==0) {
              $('.main-content #welcome-message').remove();
              $('.main-content table').show();
            }
          };
          reader.readAsBinaryString(file);
        }(file);
      });
      
      $('#export').on('click',function(e) {
        exportLibrary($('#export-titles').prop('checked'));
      });

      $('#add-modal').on('shown.bs.modal', function() {
        $("#add-side-a").focus();
      }).on('hidden.bs.modal', function() {
        $('#add-modal input').val('');
      })
      $('#add-modal .save').on('click',function(e){
        e.preventDefault();
        var mand=['add-side-a','add-side-b','add-artist'],
            cancel=false;
        mand.forEach(function(v){
          $input=$('#'+v);
          if($($input).val()=='') {
            $($input).addClass('is-invalid').parent().addClass('has-danger').find('.invalid-feedback').text('Please enter a value');
            cancel=true;
          } else
            $($input).removeClass('is-invalid').parent().removeClass('has-danger').find('.invalid-feedback').text('');
        });
        if(cancel)
          return false;

        var t={
          aside:$('#add-side-a').val(),
          bside:$('#add-side-b').val(),
          artist:$('#add-artist').val(),
          artistb:$('#add-artist-b').val()
        };
        if($('#add-modal').data('editID')==undefined) {
          t=titleCreator.addTitles([t]);
        } else {
          var id=$('#add-modal').data('editID');
          $('#add-modal').removeData('editID');
          t.id=id;
          titleCreator.updateTitle(t);
          $cells=$('table tbody tr[data-id='+id+'] td');
          $cells.each(function(i,v){
            if($(v).hasClass('aside')) $(v).text(t.aside);
            if($(v).hasClass('bside')) $(v).text(t.bside);
            if($(v).hasClass('artist')) $(v).text(t.artist+((t.artistb!=='') ? ' / '+t.artistb : ''));
          });
        }
        $('#add-modal').modal('hide');

        if($('#welcome-message').length) {
          $("#welcome-message").hide();
          $('.main-content table').show();
        }
        addRow(t[0]);
      });

      $(document).on('click', '.title-menu-button', function(e) {
        var top = e.pageY;
        var left = e.pageX;
        $("#context-menu").css({
          display: "block",
          top: top,
          left: left
        });
        $("#context-menu").data('row',$(this).parent().parent());
        return false;
      });
      $(document).on('click',function(){
        $("#context-menu").hide();
      });
      $("#context-menu .remove").on("click", function(e) {
        $t=$('#context-menu').data('row');
        titleCreator.removeTitle($t.data('id'));
        $t.remove();
        e.preventDefault();
      });
      $("#context-menu .edit").on("click", function(e) {
        e.preventDefault();
        $t=$('#context-menu').data('row');
        id=$t.data('id');
        var title=titleCreator.getTitle(id);
        $('#add-modal input#add-side-a').val(title.aside);
        $('#add-modal input#add-side-b').val(title.bside);
        $('#add-modal input#add-artist').val(title.artist);
        $('#add-modal input#add-artist-b').val(title.artistb);
        $('#add-modal').data('editID',id);
        $('#add-modal').modal();
      });

      $('#write-document').on('click',function(e) {
        e.preventDefault();
        //need to send an array of ids to print

        window.titleCreator.start();
      });

      $('#options-clear').on('click',function(e) {
        e.preventDefault();
        $('#titles tbody').empty();
        window.titleCreator.reset();
      });
      
      $('#option-paperType').on('change',function(e){
        e.preventDefault();
	//set note to use LEGAL not letter
        if($(this).val()=='single12')
          $('#paperType-message').html('<small><strong>Note:</strong> For these strips, make sure you set the paper type to LEGAL when printing</small>');
        else
          $('#paperType-message').text('');
        //only enable valid options depending on paperType (letter paper needs designs, others are pre-printed)
        if($(this).val()=='letter') {
          $('.onlyplain').attr('disabled',false);
          $('#option-style').change(); //update the preview
	} else {
          $('.onlyplain').attr('disabled',true);
          $('#design-preview').attr('src','images/designs/plain.svg');
	  inlineSVG($('#design-preview'));
        }
      });

      $('#option-style').on('change',function(e){
        e.preventDefault();
        if($(this).val()=='holly' || $(this).val()=='candycane')
          $('.nocolor').attr('disabled',true);
        else
          $('.nocolor').attr('disabled',false);

      });

      $('#option-artistFillColor, #option-titleFillColor, #option-primaryColor, #option-style, #option-font, #option-uppercase, #option-quotes').on('change',function(e) {
        e.preventDefault();
        $('#design-preview').attr('src','images/designs/'+$('#option-style').val()+'.svg');
	inlineSVG($('#design-preview'));
      });

      $('#menu-options').on('click',function(e) {
        e.preventDefault();
        var options=window.titleCreator.getOptions();
        $('#option-uppercase').prop('checked',options.allCaps);
        $('#option-quotes').prop('checked',options.quotes);
        $('#option-artistFillColor').prop('checked',options.artistFillColor);
        $('#option-titleFillColor').prop('checked',options.titleFillColor);
        $('#option-primaryColor').val(options.primaryColor);
        $('#option-paperType').val(options.paperType);
        $('#option-font').val(options.font);
        $('#option-style').val(options.style);
        $('#option-paperType').change(); //sets note correctly
        $('#option-style').change(); //sets note correctly

        $('#design-preview').attr('src','images/designs/'+options.style+'.svg');
	inlineSVG($('#design-preview'));

        $('#options-modal').modal();
      });

      $('.btn.save-options').on('click',function(e){
        e.preventDefault();
        window.titleCreator.setOption('allCaps',$('#option-uppercase').prop('checked'));
        window.titleCreator.setOption('quotes',$('#option-quotes').prop('checked'));
        window.titleCreator.setOption('primaryColor',$('#option-primaryColor').val());
        window.titleCreator.setOption('paperType',$('#option-paperType').val());
        window.titleCreator.setOption('artistFillColor',$('#option-artistFillColor').prop('checked'));
        window.titleCreator.setOption('titleFillColor',$('#option-titleFillColor').prop('checked'));
        window.titleCreator.setOption('font',$('#option-font').val());
        window.titleCreator.setOption('style',$('#option-style').val());
        $('#options-modal').modal('hide');
      });
      
      $('#menu-export').on('click',function(e) {
        e.preventDefault();
        $('#export-modal').modal();
      });
      
      var titles=titleCreator.getTitles();
      if(titles.length>0) {
        titles.forEach(function(e){
          addRow(e);
        });
      } else {
        $('.main-content').prepend('<div class="row" id="welcome-message"><div class="col-md-12"><img src="arrow.svg" style="width: 80px; margin-left: 10px; margin-right: 10px;" class="float-left" ><h2>welcome!</h2>It looks like you\'re new here. Add your records to get started, set some options and hit Print to create yor title strips</div></div></div>');
        $('.main-content table').hide();
      }

      var keys=Object.keys(titleCreator.styles)
      keys.forEach(function(key){
        $('#option-style').append(crel('option',{'value':key},titleCreator.styles[key].name));
      });

      var style = document.createElement('style');
      style.type = 'text/css';
      for(var key in pdfMake.vfs) {
        if(pdfMake.vfs.hasOwnProperty(key) && key.indexOf('.ttf')>0) {
          style.append('@font-face {font-family: '+key.substr(0,key.length-4)+';src: url(data:font/ttf;base64,'+pdfMake.vfs[key]+');}');
          $('#option-font').append('<option value="'+key.substr(0,key.length-4)+'" style="font-family:'+key.substr(0,key.length-4)+'">'+key.substr(0,key.length-4)+'</option>');
        }
      }

      document.getElementsByTagName('head')[0].appendChild(style);

      function addSVGText($g,text,options) {
        var newText = document.createElementNS('http://www.w3.org/2000/svg',"text");
	var k=Object.keys(options);
        k.forEach(function(key) {
          newText.setAttributeNS(null,key,options[key]);
        });
        var textNode = document.createTextNode(text);
        newText.appendChild(textNode);
        $g.append(newText);
      }

      function buildPreview() {
        var pc=$('#option-primaryColor').val(),
	    t=shadeColor2(pc,0.8);
        $('#design-preview #design').css('fill',pc);
        if($('#option-artistFillColor').is(':checked'))
          $('#design-preview #artist_fill').css('fill',t);
        if($('#option-titleFillColor').is(':checked'))
          $('#design-preview #title_fill').css('fill',t);

	var uc=$('#option-uppercase').is(":checked"),
	uq=$('#option-quotes').is(":checked"),
	text=[
          ((uq)?'"':'')+((uc)?'A SIDE':'A Side')+((uq)?'"':''),
          ((uq)?'"':'')+((uc)?'B SIDE':'B Side')+((uq)?'"':''),
          ((uc)?'ARTIST':'Artist')
        ];

        var $g=$('#options-modal svg g');
	var font=$('#option-font option:selected').text();

	var options={"x":112.5,"y":19,"text-anchor":"middle","font-size":"13px","font-family":$('#option-font option:selected').text()}
        addSVGText($g,text[0],options);

        options["y"]=63;
        addSVGText($g,text[1],options);

        options["y"]=36;
        options["alignment-baseline"]="central";
        options["font-size"]="10px";
        addSVGText($g,text[2],options);
      }

      function inlineSVG($img,primaryColor) {
        var imgID = $img.attr('id');
        var imgClass = $img.attr('class');
        var imgURL = $img.attr('src');
        jQuery.get(imgURL, function(data) {
          var $svg = jQuery(data).find('svg');
          if(typeof imgID !== 'undefined') {
            $svg = $svg.attr('id', imgID);
          }
          if(typeof imgClass !== 'undefined') {
            $svg = $svg.attr('class', imgClass+' replaced-svg');
            $svg = $svg.removeAttr('xmlns:a');
            if(!$svg.attr('viewBox') && $svg.attr('height') && $svg.attr('width')) {
              $svg.attr('viewBox', '0 0 ' + $svg.attr('height') + ' ' + $svg.attr('width'))
            }
            $img.replaceWith($svg);
            buildPreview();
	  }
        }, 'xml');
      };
    });
  </script>
</html>
