<!DOCTYPE html>
  <html lang='en'>
  <head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Jukebox Title Strip Creator</title>
    <script src='pdfmake.min.js'></script>
    <script src='vfs_fonts.js'></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crel/3.1.0/crel.min.js"></script>
    <link rel="stylesheet" href="bootstrap.css">
    <style>
      .navbar-dark .navbar-nav .nav-link:hover, .navbar-dark .navbar-nav .nav-link:focus { color: #FFC930; }
      .main-content { margin-top: 90px; }
      .right { text-align: right; }
      .btn { border-radius: .17rem; border-width: 2px; }
      .btn.btn-info.nofill { background: rgba(0,0,0,0) !important; color: #3498DB; }
      .title input { border-radius: 0; border: 1px solid #fff; padding-left: 0; }
      .title input:focus, .title input:active { border-color: #fff; border-bottom: 1px solid #ced4da; box-shadow: none; background-color: #f5f5f5; }
      .modal-content { border: none; border-radius: .2rem; }
      .modal-header { padding: 1rem .75rem; background-color: #3498DB; border-color: #3498DB; border-bottom: none; border-top-left-radius: .2rem; border-top-right-radius: .2rem; }
      .modal-header h4 { font-size: 1rem; color: #fff; }
      .modal-footer { justify-content: center; }
      .modal-footer .btn { padding: .375rem 1.35rem; }
      .modal .close { color: #fff; opacity: 1; }
      .custom-checkbox .custom-control-input:checked ~ .custom-control-label::before { background-color: #3498DB; }
    </style>
  </head>
  <body>
    <div class="navbar navbar-expand-lg fixed-top bg-info navbar-dark">
      <div class="container">
        <a href="../" class="navbar-brand">JB TITLE STRIPS</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" id="menu-options" href="#">Options</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="menu-export" href="#">Export</a>
            </li>
          </ul>

          <ul class="nav navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" id="menu-clear" href="#">Clear all</a>
            </li>
          </ul>

        </div>
      </div>
    </div>
    
    <div class="container main-content">
      <div class="bs-docs-section clearfix">
        <div class="row">
          <div class="col-lg-12">
            <table class="table" id="titles">
              <thead>
                <tr>
                  <th>A Side</th>
                  <th>B Side</th>
                  <th>Artist</th>
                </tr>
              </thead>
              <tbody>
                <tr class="title">
                  <td><input type="text" class="sidea form-control" placeholder="A Side"></td>
                  <td><input type="text" class="sideb form-control" placeholder="B Side"></td>
                  <td><input type="text" class="artist form-control" placeholder="Artist"></td>
                </tr>
              </tbody>
            </table>
            <div class="col-lg-12 right">
              <button class="btn btn-info" id="add-title">+ Add title</button>
            </div>
            <div class="col-lg-12">
              <button class="btn btn-primary" id="write-document">Create PDF</button>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <div class="modal fade" id="options-modal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Options</h4>
            <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>
          <div class="modal-body">
            <fieldset>
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="option-uppercase" checked="">
                  <label class="custom-control-label" for="option-uppercase">Force uppercase</label>
                </div>
              </div>
            <fieldset>
              <div class="form-group">
                <div class="custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" id="option-quotes" checked="">
                  <label class="custom-control-label" for="option-quotes">Add quotes to titles</label>
                </div>
              </div>
            </fieldset>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-info nofill" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-info save-options">Save</button>
          </div>
        </div>
      </div>
    </div>

  </body>
  <script src="titlecreator.js"></script>
  <script>
    function saveTitles() {
      var titles=getTitles();
      sessionStorage.setItem('titles',JSON.stringify(titles));
    }
    function getTitles() {
      var o=[];
      $('#titles .title').each(function(i){
        var $inputs=$($(this)[0]).find('input');
        //potentially wrong, assumes jQuery will pull them out in DOM order but faster than anything else I can think of right now
        if($($inputs[0]).val()!='' && $($inputs[1]).val()!='' && $($inputs[2]).val()!='')
          o.push({
            aside:$($inputs[0]).val(),
            bside:$($inputs[1]).val(),
            artist:$($inputs[2]).val()
          });
      })
      return o;
    }
    
    $(document).ready(function(){
    
      function addRow(content=null){
        var html=crel('tr',{'class':'title'},
          crel('td',crel('input',{'type':'text', 'class':'sidea form-control', 'placeholder':'A Side', 'value':((content===null) ? '' : content.aside) })),
          crel('td',crel('input',{'type':'text', 'class':'sideb form-control', 'placeholder':'B Side', 'value':((content===null) ? '' : content.bside) })),
          crel('td',crel('input',{'type':'text', 'class':'artist form-control', 'placeholder':'Artist', 'value':((content===null) ? '' : content.artist) }) )
        )
        $('#titles tbody').append(html);
          
        $inputs=$('#titles').find('input');
        $($($inputs)[$($inputs).length-3]).focus();
      }
      
      $('#write-document').on('click',function(e) {
        e.preventDefault();
        var titles=getTitles();
        if(titles.length>0)
          window.titleCreator.start(titles);
      });

      $('#add-title').on('click',function(e) {
        e.preventDefault();
        addRow();
      });
      
      $('#menu-clear').on('click',function(e) {
        e.preventDefault();
        $('#titles tbody').empty();
        window.titleCreator.reset();
        addRow();
      });
      
      $('#menu-options').on('click',function(e) {
        e.preventDefault();
        var options=window.titleCreator.getOptions();
        $('#option-uppercase').prop('checked',options.allCaps);
        $('#option-quotes').prop('checked',options.quotes);
        $('#options-modal').modal();
      });

      $('.btn.save-options').on('click',function(e){
        e.preventDefault();
        window.titleCreator.setOption('allCaps',$('#option-uppercase').prop('checked'));
        window.titleCreator.setOption('quotes',$('#option-quotes').prop('checked'));
        $('#options-modal').modal('hide');
      });
      
      $('#menu-export').on('click',function(e) {
        e.preventDefault();
        var out={
          titles:getTitles(),
          options:window.titleCreator.getOptions()
        }
        var data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(out));
        var a = document.createElement('a');
        a.setAttribute("href", data);
        a.setAttribute("download","jblabels.json");
        document.body.appendChild(a);
        a.click();
        a.remove();
      });
      
      $(document.body).on('blur','.artist, .sidea, .sideb',function(e) {
        saveTitles();
      });
      
      var titles=JSON.parse(sessionStorage.getItem('titles'))||[];
      if(titles.length>0) {
        $('#titles tbody').empty();
        titles.forEach(function(e){
          addRow(e);
        });
        addRow();
      }
            
      $inputs=$('#titles').find('input');
      $($($inputs)[$($inputs).length-3]).focus();

      //insert the custom font we've already pulled in for PDFMake
      var style = document.createElement('style');
      style.type = 'text/css';
      style.innerHTML = '@font-face {font-family: RetroBold;src: url(data:font/ttf;base64,'+pdfMake.vfs['RetroBold.ttf']+');}';
      document.getElementsByTagName('head')[0].appendChild(style);
    });
  </script>
</html>